<%# Consolidated Forecast View %>
<% content_for :title do %>
  <%= @forecast ? "Weather for #{@forecast.forecast_data&.dig('location', 'name') || @forecast.address}" : "Weather Forecast" %>
<% end %>

<div class="app-container bg-gray-200">
  <div class="text-center mb-6">
    <% if @forecast %>
      <% 
        # Get timezone from API if available
        timezone = nil
        if @forecast.forecast_data.present?
          timezone_id = @forecast.forecast_data.dig('location', 'tz_id')
          timezone = ActiveSupport::TimeZone[timezone_id] if timezone_id.present?
        end
        # Create time with proper timezone
        local_time = timezone.present? ? Time.current.in_time_zone(timezone) : Time.current
        # Get location name
        location_name = @forecast.forecast_data&.dig('location', 'name') || @forecast.address
      %>
      <div class="text-3xl font-medium text-gray-700">
        Weather for <%= location_name %>
      </div>
      <div class="text-sm text-gray-600">
        <%= "#{local_time.strftime('%A, %B %d')} • #{local_time.strftime('%I:%M %p %Z')}" %>
        <% if timezone.present? %>
          (<%= timezone.name %>)
        <% end %>
      </div>
      <% if @forecast && @forecast.from_cache %>
        <div class="text-xs text-gray-500 mt-1 mb-2">
          <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Cached</span>
          <span class="ml-1">Key: <%= @forecast.normalized_address %></span>
        </div>
      <% end %>
    <% else %>
      <div class="text-2xl font-bold">Your Weather</div>
    <% end %>
  </div>
  
  <!-- Search form -->
  <div class="search-container">
    <%= form_with url: search_forecasts_path, method: :get, class: "search-form" do |form| %>
      <div class="search-input-container">
        <%= form.text_field :address, 
            value: @search_query, 
            class: "search-input", 
            placeholder: "Enter city, zip code, or address" %>
      </div>
      <%= form.submit "Get Forecast", 
          name: "button", 
          class: "search-button" %>
    <% end %>
  </div>

  <% if @forecast %>
    <div class="forecast-container rounded-lg overflow-hidden shadow-md">
      <div class="p-4 pb-0 bg-white border-b border-gray-300">
        <h2 class="text-2xl font-medium text-gray-700 mb-0">
          <% if @forecast.present? %>
            <% location_name = @forecast.forecast_data&.dig('location', 'name') %>
            <% location_region = @forecast.forecast_data&.dig('location', 'region') %>
            <% location_country = @forecast.forecast_data&.dig('location', 'country') %>
            
            <% if location_name.present? %>
              <span class="flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <%= location_name %><%=
              if location_region.present?
                ", " + location_region
              end
              %><%=
              if location_country.present? && location_country != "United States of America"
                ", " + location_country
              end
              %>
              </span>
            <% else %>
              <span class="flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <%= @forecast.address %>
              </span>
            <% end %>
          <% else %>
            Weather Forecast
          <% end %>
        </h2>
        <% 
          # Get timezone offset from API if available
          timezone = nil
          if @forecast.forecast_data.present?
            timezone_id = @forecast.forecast_data.dig('location', 'tz_id')
            timezone = ActiveSupport::TimeZone[timezone_id] if timezone_id.present?
          end
          # Create time with proper timezone
          local_time = timezone.present? ? Time.current.in_time_zone(timezone) : Time.current
        %>
        <!-- Timestamp removed as it's now displayed at the top of the page -->
      </div>
      
      <!-- Weather data display section -->
      <div class="weather-data p-3 pt-0 bg-white">
        <div class="forecast-cards">
          <!-- Current weather card -->
          <div class="forecast-card">
            <div class="text-center">
              <% 
                # Get the current date in the location's timezone
                location_date = local_time.to_date
                # Get the date from the first forecast day if available
                first_forecast_date = nil
                if @forecast.daily_forecasts.present?
                  first_day = get_forecast_days(@forecast.daily_forecasts, timezone&.name, @forecast.should_use_imperial?).first
                  first_forecast_date = first_day[:date].to_date if first_day
                end
                
                # Determine if the first forecast day is today in the location's timezone
                is_today = first_forecast_date == location_date
                day_label = is_today ? "Today" : local_time.strftime('%a')
                
                # If it's not today, also show the date
                day_display = is_today ? "Today" : local_time.strftime('%a')
              %>
              <div class="text-blue-700 font-semibold text-sm"><%= day_display %></div>
              <% if local_time %>
                <div class="text-xs text-gray-500"><%= local_time.strftime('%-m/%-d') %></div>
              <% end %>
              
              <div class="forecast-icon">
                <% current_condition = @forecast.forecast_data&.dig('current_weather', 'condition') || 
                                       @forecast.forecast_data&.dig('current', 'condition') %>
                <%= render partial: 'shared/weather_api_icon', locals: { 
                  condition: current_condition || @forecast.conditions, 
                  size_class: 'w-20 h-20 mx-auto' 
                } %>
              </div>
              
              <div class="current-temp"><%= @forecast.current_temp_display %> now</div>
              <div class="high-low-temp"><%= @forecast.high_low_display %></div>
              <div class="condition-text"><%= @forecast.conditions.titleize %></div>
            </div>
          </div>
          
          <!-- Extended forecast -->
          <% if @forecast.daily_forecasts.present? %>
            <% use_imperial = @forecast.should_use_imperial? %>
            <% days = get_forecast_days(@forecast.daily_forecasts, timezone&.name, use_imperial) %>
            <% 
              # Set the current date based on the location's timezone
              today = local_time&.to_date || Date.current
              # Filter out today from the forecast days to prevent duplication
              future_days = days.reject { |day| day[:date].to_date == today }
              # Take the next two days
              future_days.first(2).each do |day| 
            %>
              <div class="forecast-card">
                <div class="text-center">
                  <div class="text-blue-700 font-semibold text-sm"><%= day[:date].strftime('%a') %></div>
                  <div class="text-xs text-gray-500"><%= day[:date].strftime('%-m/%-d') %></div>
                  
                  <div class="forecast-icon">
                    <%= render partial: 'shared/weather_api_icon', locals: { 
                      condition: day[:condition], 
                      size_class: 'w-10 h-10 mx-auto' 
                    } %>
                  </div>
                  
                  <div class="high-low-temp"><%= format_temp(day[:high_temp], @units) %> / <%= format_temp(day[:low_temp], @units) %></div>
                  <div class="condition-text"><%= day[:condition].is_a?(Hash) ? day[:condition]['text'] : day[:condition].to_s.titleize %></div>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
      
      <!-- Technical details section with toggle functionality -->
      <div data-controller="toggle" class="details-section">
        <!-- Toggle header -->
        <div class="p-2 text-right">
          <button 
            data-action="toggle#toggle"
            class="details-toggle-button"
          >
            <span class="details-text">Details</span>
            <span
              data-toggle-target="icon"
              class="details-icon"
            >▶</span>
          </button>
        </div>
        
        <!-- Content (hidden by default) -->
        <div 
          data-toggle-target="content"
          class="hidden p-4 details-content"
        >
          <!-- Metadata section -->
          <div class="mb-4">
            <h4 class="text-md font-semibold">Metadata</h4>
            <% 
              # Calculate cache expiry time
              cache_expiry = @forecast.queried_at + 30.minutes
              minutes_until_expiry = ((cache_expiry - Time.current) / 60).round
              
              # Convert queried_at to the location's timezone
              queried_at_local = timezone.present? ? @forecast.queried_at.in_time_zone(timezone) : @forecast.queried_at
            %>
            <table class="metadata-table mt-2">
              <tr>
                <td class="table-header">Queried At</td>
                <td>
                  <%= queried_at_local.strftime("%Y-%m-%d %I:%M %p %Z") %>
                </td>
              </tr>
              <tr>
                <td class="table-header">Cache Status</td>
                <td>
                  <%= @forecast.from_cache ? "Fresh" : "Expired" %>
                  <% if @forecast.from_cache %>
                    - Expires in <%= minutes_until_expiry > 0 ? "#{minutes_until_expiry} minutes" : "expired" %>
                  <% end %>
                </td>
              </tr>
              <tr>
                <td class="table-header">Display Units</td>
                <td><%= @forecast.display_units %></td>
              </tr>
              <tr>
                <td class="table-header">Query</td>
                <td><%= @forecast.address %></td>
              </tr>
              <tr>
                <td class="table-header">Cache Key</td>
                <td><%= @forecast.normalized_address %></td>
              </tr>
            </table>
          </div>
          
          <!-- Raw weather data -->
          <h3 class="text-md font-semibold mb-2">Raw Weather Data</h3>
          <div class="overflow-x-auto">
            <pre class="raw-data-container p-2 text-xs"><code><%= JSON.pretty_generate(@forecast.forecast_data || {}) %></code></pre>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  
  <!-- JavaScript for format_temp in the browser -->
  <script>
  function format_temp(temp, units) {
    if (units === 'imperial') {
      return `${Math.round(temp)}°F`;
    } else {
      return `${Math.round(temp)}°C`;
    }
  }
  </script>
</div>
