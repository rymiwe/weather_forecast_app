<% if @forecast.present? %>
  <div class="forecast-display">
    <% use_imperial = @forecast.display_units == 'imperial' %>
    <h2 class="forecast-header">
      <% 
        location_name = @forecast.forecast_data&.dig('location', 'name')
        location_region = @forecast.forecast_data&.dig('location', 'region')
        location_country = @forecast.forecast_data&.dig('location', 'country')
      %>
      
      <% if location_name.present? %>
        <span class="flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <%= location_name %><%=
          if location_region.present?
            ", " + location_region
          end
          %><%=
          if location_country.present? && location_country != "United States of America"
            ", " + location_country
          end
          %>
        </span>
      <% else %>
        <span class="flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <%= @forecast.address %>
        </span>
      <% end %>
    </h2>
    <% 
      # Get timezone offset from API if available
      timezone = nil
      if @forecast.forecast_data.present?
        timezone_id = @forecast.forecast_data.dig('location', 'tz_id')
        timezone = ActiveSupport::TimeZone[timezone_id] if timezone_id.present?
      end
      # Create time with proper timezone
      local_time = timezone.present? ? Time.current.in_time_zone(timezone) : Time.current
    %>
    
    <div class="forecast-metadata">
      <% if @forecast.queried_at.present? %>
        <div class="forecast-timestamp">
          <% cache_age = ((Time.current - @forecast.queried_at) / 60).round %>
          <% if @forecast.from_cache || cache_age > 0 %>
            <span class="forecast-cached">
              Cached Result 
              <span class="forecast-age"><%= distance_of_time_in_words(@forecast.queried_at, Time.current) %> ago</span>
              <%= link_to refresh_forecast_path(address: @forecast.address), 
                 class: "refresh-link", 
                 data: { turbo_frame: "forecast_results" } do %>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
              <% end %>
            </span>
          <% end %>
        </div>
      <% end %>
      
      <div class="forecast-time">
        <%= local_time.strftime('%A, %B %d, %Y at %l:%M %p') %>
      </div>
    </div>
    
    <% if @error.present? %>
      <div class="forecast-error">
        <%= @error %>
      </div>
    <% else %>
      <div class="bg-gray-200 rounded-xl shadow-md p-6">
        <div class="current-temperature">
          <div class="text-center mb-2">
            <div class="text-base font-bold tracking-wide text-black mb-1">Current Weather</div>
            <%= render 'shared/weather_api_icon', condition: @forecast.forecast_data['current']['condition'], size_class: 'w-20 h-20 mx-auto' %>
            <% if @forecast.forecast_data['current']['condition'].present? && @forecast.forecast_data['current']['condition']['text'].present? %>
              <div class="inline-block mt-2 px-3 py-1 rounded bg-gray-100 text-blue-700 text-xs font-semibold shadow-sm">
                <%= @forecast.forecast_data['current']['condition']['text'] %>
              </div>
            <% end %>
          </div>
          <div class="current-temp-value flex items-center justify-center gap-2">
            <%= display_temperature(@forecast.forecast_data.dig('current', 'temp_c'), @forecast.forecast_data.dig('current', 'temp_f'), use_imperial) %>
          </div>
        </div>
      </div>
      
      <!-- Forecast Cards: icon with tooltip, no info icon, no high/low text -->
      <div class="forecast-cards-container">
        <% forecast_days = get_forecast_days(@forecast.extended_forecast, timezone, use_imperial) %>
        <% forecast_days.each_with_index do |day, index| %>
          <div class="forecast-card bg-white rounded shadow-md p-4"
               data-controller="weather-card"
               data-weather-card-visible-class="opacity-100"
               data-weather-card-hidden-class="hidden"
               data-weather-card-loading-class="opacity-50">
            <div class="forecast-card-header">
              <h3 class="forecast-day text-lg text-gray-600">
                <%= index == 0 ? "Today" : day[:day_name] %>
              </h3>
            </div>
            <div class="forecast-card-body flex flex-col items-center">
              <span class="relative group">
                <%= render 'shared/weather_api_icon', condition: day[:condition], size_class: 'w-10 h-10 mx-auto' %>
                <% if day[:condition].present? %>
                  <span class="absolute left-1/2 -translate-x-1/2 mt-2 px-2 py-0.5 rounded bg-gray-800 text-white text-[10px] opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity duration-150 z-10 shadow-md whitespace-nowrap">
                    <%= day[:condition]['text'] %>
                  </span>
                <% end %>
              </span>
              <div class="flex gap-2 mt-2">
                <span class="font-semibold text-red-600 text-lg">
                  <%= display_temperature(day[:high_c], day[:high_f], use_imperial) %>
                </span>
                <span class="font-semibold text-blue-600 text-lg">
                  <%= display_temperature(day[:low_c], day[:low_f], use_imperial) %>
                </span>
              </div>
            </div>
            <% if day[:summary].present? %>
              <div class="forecast-card-summary mt-2 text-xs text-gray-500 text-center">
                <%= day[:summary] %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="empty-forecast-message">
    <p>Enter a location above to get a weather forecast</p>
  </div>
<% end %>
